<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-8">Subscription Management</h1>
  
  <% if @current_subscription %>
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Current Subscription
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">
          Manage your subscription and billing details
        </p>
      </div>
      <div class="border-t border-gray-200">
        <dl>
          <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Plan</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
              <%= @current_subscription.plan.name %>
              <% if @current_subscription.trialing? %>
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  Trial (<%= @current_subscription.days_remaining_in_trial %> days left)
                </span>
              <% elsif @current_subscription.active? %>
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Active
                </span>
              <% elsif @current_subscription.trial_expired? %>
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  Trial Expired
                </span>
              <% else %>
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  <%= @current_subscription.status.humanize %>
                </span>
              <% end %>
            </dd>
          </div>
          
          <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Price</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
              <%= @current_subscription.plan.display_price %>
            </dd>
          </div>
          
          <% if @current_subscription.current_period_end %>
            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500">
                <% if @current_subscription.cancel_at_period_end? %>
                  Ends on
                <% else %>
                  Renews on
                <% end %>
              </dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <%= @current_subscription.current_period_end.strftime("%B %d, %Y") %>
              </dd>
            </div>
          <% end %>
          
          <% if @current_subscription.trial_ends_at %>
            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500">Trial ends</dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <%= @current_subscription.trial_ends_at.strftime("%B %d, %Y at %l:%M %p") %>
              </dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>
    
    <div class="flex space-x-4">
      <% if @current_subscription.trialing? || @current_subscription.trial_expired? %>
        <%= link_to "Subscribe Now", new_subscription_path(plan_id: @current_subscription.plan_id), 
            class: "bg-indigo-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-indigo-700" %>
      <% elsif @current_subscription.active? && !@current_subscription.cancel_at_period_end? %>
        <%= link_to "Change Plan", pricing_path, 
            class: "bg-gray-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-gray-700" %>
        <%= button_to "Cancel Subscription", cancel_subscription_path(@current_subscription), 
            method: :post, 
            class: "bg-red-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-red-700", 
            data: { confirm: "Are you sure you want to cancel your subscription? It will remain active until #{@current_subscription.current_period_end.strftime('%B %d, %Y')}." } %>
      <% elsif @current_subscription.cancel_at_period_end? %>
        <p class="text-gray-600">Your subscription is scheduled to cancel. You can continue using it until the end of the billing period.</p>
      <% end %>
      
      <% if @current_subscription.stripe_subscription_id && ENV['STRIPE_CUSTOMER_PORTAL_ENABLED'] == 'true' %>
        <%= link_to "Manage Billing", "#", 
            class: "bg-gray-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-gray-700",
            title: "Stripe Customer Portal" %>
      <% end %>
    </div>
  <% else %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
      <p class="text-yellow-800">
        You don't have an active subscription. 
        <%= link_to "View available plans", pricing_path, class: "font-semibold underline" %> to get started.
      </p>
    </div>
  <% end %>
  
  <% if !ENV['STRIPE_PUBLISHABLE_KEY'] || !ENV['STRIPE_SECRET_KEY'] %>
    <div class="mt-8 bg-amber-50 border border-amber-200 rounded-lg p-6">
      <h4 class="text-amber-900 font-semibold mb-2">Stripe Integration Not Configured</h4>
      <p class="text-amber-800 mb-4">
        To enable subscription purchases, configure your Stripe API keys:
      </p>
      <ol class="list-decimal list-inside text-amber-800 space-y-2">
        <li>Sign up for a <a href="https://stripe.com" target="_blank" class="underline">Stripe account</a></li>
        <li>Get your API keys from the <a href="https://dashboard.stripe.com/apikeys" target="_blank" class="underline">Stripe Dashboard</a></li>
        <li>Add these environment variables:
          <pre class="mt-2 bg-amber-100 p-2 rounded text-sm">STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_... (optional)</pre>
        </li>
        <li>Restart your Rails server</li>
      </ol>
    </div>
  <% end %>
</div>